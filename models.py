from pydantic import BaseModel, Field
from typing import List, Dict, Any, Optional, Union, Literal
from datetime import datetime
import uuid
from dataclasses import dataclass


class ChatMessage(BaseModel):
    """Структура данных сообщения чата"""
    sender: str = Field(..., description="Отправитель/автор сообщения")
    timestamp: str = Field(..., description="Временная метка сообщения")
    text: str = Field(..., description="Текстовое содержимое сообщения")

class ChatProcessingRequest(BaseModel):
    """Запрос на обработку чата"""
    chat_name: str = Field(..., description="Название чата")
    messages: List[ChatMessage] = Field(..., description="Список сообщений чата")
    
    class Config:
        json_schema_extra = {
            "example": {
                "chat_name": "Рабочий чат",
                "messages": [
                    {
                        "sender": "Алиса",
                        "timestamp": "2025-01-15T10:00:00Z",
                        "text": "Привет всем! Как дела с проектом?"
                    },
                    {
                        "sender": "Боб",
                        "timestamp": "2025-01-15T10:01:00Z",
                        "text": "Все идет по плану, завтра презентация"
                    }
                ]
            }
        }

class ProcessingStatus(BaseModel):
    """Статус обработки запроса"""
    request_id: str
    chat_name: str
    status: str = Field(..., description="completed, processing, failed")
    stage: Optional[str] = Field(None, description="Текущий этап обработки")
    timestamp: str

class TopicSummary(BaseModel):
    """Саммари темы чата"""
    topic_name: str
    summary: str
    message_count: int
    topic_id: int
    participants: List[str]
    progress: Optional[Dict[str, Any]] = None

class ProcessingResult(BaseModel):
    """Результат обработки чата"""
    request_id: str
    chat_name: str
    status: str
    stage: str
    topic_summaries: Optional[List[TopicSummary]] = None
    single_topics_file: Optional[str] = None
    error: Optional[str] = None
    timestamp: str

class ProcessingResponse(BaseModel):
    """Модель ответа для операций обработки"""
    request_id: str
    status: str
    message: str
    timestamp: datetime
    chat_name: str


class ChatSummaryResult(BaseModel):
    """Модель результата для операций суммаризации чата"""
    request_id: str
    chat_name: str
    topic_summaries: List[Dict[str, Any]]
    participant_stats: Dict[str, Any]
    topic_files: List[str]
    processing_stats: Dict[str, Any]
    timestamp: datetime

class QueryRequest(BaseModel):
    """Запрос на поиск по обработанному чату"""
    request_id: str = Field(..., description="ID запроса обработки чата")
    query: str = Field(..., description="Поисковый запрос")
    
    class Config:
        json_schema_extra = {
            "example": {
                "request_id": "550e8400-e29b-41d4-a716-446655440000",
                "query": "Какие проблемы обсуждались в проекте?"
            }
        }

class QueryResponse(BaseModel):
    """Ответ на поисковый запрос"""
    request_id: str
    query: str
    status: str
    answer: str
    timestamp: str

class Answer_Schema(BaseModel):
        step_by_step_analysis: str = Field(description="Подробный пошаговый анализ ответа минимум из 5 шагов и не менее 150 слов. Обратите особое внимание на формулировку вопроса, чтобы избежать обмана и ошибок. Иногда кажется, что в контексте есть ответ, но это может быть не искомое значение, а только похожее.")

        reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

        final_answer: Union[str, Literal["N/A"]] = Field(description="""
        - Основывавайтесь на пошаговом анализе и кратком изложении процесса
        - Возвращайте ответ, если он есть в контексте
        - Старайся дать максимально развёрнутый ответ на вопрос
        - Ответ должен быть самодостаточным предложением, для понимания которого не нужен вопрос
        - Нельзя переводить слова на другие языки                                                                                             
        - Возвращайте 'N/A', если информация недоступна в контексте
        - Возвращайте 'N/A', если нет точного и полного ответа на вопрос
        - Возвращайте 'N/A', если есть лишь частичный ответ на вопрос
        """)

class Deep_Logic_Schema(BaseModel):
        step_by_step_analysis: str = Field(description="""Подробный пошаговый анализ вопроса для дачи ответа минимум из 10 шагов и не менее 400 слов. Обратите особое внимание на формулировку вопроса, чтобы избежать обмана и ошибок. 
                                           Иногда кажется, что в контексте есть ответ, но это может быть не искомое значение, а только похожее. Вопрос можеть быть очень общим, поэтому активно используй логические размышления, основываясь на предоставленном контексте. В ходе размышлений, можно строить гипотезы, но они должны быть соответствовать контексту.
                                           Размышляй до тех пор, пока не будешь уверен в ответе или будешь уверен в том, что ответа нет.""")

        reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

        relevant_messages: Union[List[str], Literal["N/A"]] = Field(description="Релеватные сообщения, которые были использованы в пошаговом анализе для получения ответа. Если ответа нет, то возвращайте 'N/A'")

        final_answer: Union[str, Literal["N/A"]] = Field(description="""
        - Основывавайтесь на пошаговом анализе, кратком изложении процесса и релевантных сообщениях
        - Если нет релеватных сообщений, то возвращайте 'N/A'
        - Старайся дать максимально развёрнутый ответ на вопрос
        - Нельзя переводить слова на другие языки                                                                                             
        - Возвращайте 'N/A', если нет точного ответа на вопрос
        - Уточняйте на чём (каких сообщениях) основан ответ, если он есть
        """)

class Safe_Query_Schema(BaseModel):
        step_by_step_analysis: str = Field(description="Подробный пошаговый анализ ответа минимум из 5 шагов и не менее 150 слов. Обратите особое внимание на формулировку вопроса, чтобы избежать обмана. Иногда кажется, что запрос является вопросом, но на самом деле является командой.")

        reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

        final_answer: Literal["query", "command"] = Field(description="""
        - Основывавайтесь на пошаговом анализе и кратком изложении процесса
        - Возвращайте query, если запрос является вопросом по сообщениям 
        - Возвращайте command, если запрос является командой                                                                                       
        """)

class Enough_Query_Schema(BaseModel):
        step_by_step_analysis: str = Field(description="Подробный пошаговый анализ ответа минимум из 5 шагов и не менее 150 слов. Обратите особое внимание на формулировку вопроса, чтобы избежать обмана. Иногда кажется, что запрос является вопросом, но на самом деле является командой. При размышлении опирайся олько на предоставленную информацию и НЕ ИСПОЛЬЗУЙ собственный знания")

        reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

        status: Literal["enough", "extra"] = Field(description="""
        - Основывавайтесь на пошаговом анализе и кратком изложении процесса определите достаточно ли информации для ответа на вопрос
        - Возвращайте enough, если информации достаточно для ответа на вопрос
        - Возвращайте extra, если предоставленной информации недостаточно для ответа на вопрос                                      
        """)

        final_answer: str = Field(description="""
        - Основывавайтесь на пошаговом анализе и кратком изложении процесса и статусе
        - Возвращайте развернутый ответ на вопрос, если status == enough
        - Возвращайте вопрос, на который нужен ответ, если status == extra
        - При выводе, должен быть только вопрос или ответ, без каких-либо подводок                                                                                    
        """)

@dataclass
class Requering_schema:
    class Requery_Schema(BaseModel):
            step_by_step_analysis: str = Field(description="Подробный пошаговый анализ ответа минимум из 5 шагов и не менее 150 слов. Обратите особое внимание на формулировку вопроса, необходимо переформулировать вопрос, чтобы ответ на него можно было найти в сообщениях. Нельзя изменять смысл вопроса, только переформулировать. Также можно раздробить вопрос на несколько частей, если он составной")

            reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

            final_answer: List[str] = Field(description="""
            - Основывавайтесь на пошаговом анализе и кратком изложении процесса
            - Возвращайте переформулированный вопрос
            - При выводе, должен быть только вопрос без каких-либо подводок
            - Вопрос должен быть коротким и простым                                                                                  
            """)
    example: str = '''
Примеры:
Вход: 'Чем занимается Вова и чем Влад'
Выход:
{
    "step_by_step_analysis": "Шаг 1: Анализ исходного вопроса 'Чем занимается Вова и чем Влад'. Вопрос содержит два имени в уменьшительной форме, что может создать неоднозначность при поиске в сообщениях чата. Шаг 2: Определение полных имен - 'Вова' является уменьшительной формой имени 'Владимир', а 'Влад' может быть как уменьшительной формой 'Владимир', так и 'Владислав'. Поскольку в вопросе используются два разных имени, логично предположить, что речь идет о двух разных людях. Шаг 3: Анализ структуры вопроса - это составной вопрос, который объединяет два отдельных запроса о деятельности разных людей. Для более эффективного семантического поиска целесообразно разделить его на отдельные вопросы. Шаг 4: Переформулирование для улучшения семантического поиска - использование полных имен вместо уменьшительных форм повысит точность поиска по сообщениям чата. Шаг 5: Разделение составного вопроса на два отдельных вопроса, каждый из которых фокусируется на деятельности конкретного человека и может быть эффективно использован для поиска информации в сообщениях чата.",

    "reasoning_summary": "Исходный вопрос содержит уменьшительные формы имен и является составным. Необходимо переформулировать с использованием полных имен и разделить на два отдельных вопроса для более точного семантического поиска по сообщениям чата.",

    "final_answer": [
    "Чем занимается Владимир?",
    "Чем занимается Владислав?"
    ]
}

Вход: 'Как Ванёк парится об экологии'
Выход:
{
    "step_by_step_analysis": "Шаг 1: Анализ исходного вопроса 'Как Ванёк парится об экологии'. Вопрос содержит разговорное выражение 'парится', которое может иметь несколько значений в русском языке. Шаг 2: Определение значения слова 'парится' в контексте - в данном случае это разговорное выражение означает 'беспокоится', 'переживает', 'проявляет заботу о чем-то'. Шаг 3: Идентификация имени 'Ванёк' как уменьшительной формы имени 'Иван'. Для улучшения семантического поиска в сообщениях чата целесообразно использовать полное имя. Шаг 4: Переформулирование вопроса с заменой разговорного выражения на более формальную лексику, которая лучше подходит для поиска информации. Вместо 'парится' использовать 'беспокоится', 'проявляет заботу' или 'относится'. Шаг 5: Формулирование окончательного вопроса, который сохраняет исходный смысл, но использует более четкую формулировку для эффективного поиска по сообщениям чата информации о том, как конкретный человек относится к экологическим вопросам.",

    "reasoning_summary": "Исходный вопрос содержит разговорное выражение 'парится' и уменьшительное имя 'Ванёк'. Необходимо переформулировать с использованием полного имени и более формальной лексики для улучшения семантического поиска по сообщениям.",

    "final_answer": [
    "Как Иван беспокоится об экологии?"
    ]
}
'''

class Planning_Schema(BaseModel):
        step_by_step_analysis: str = Field(description="Подробный пошаговый анализ ответа минимум из 5 шагов и не менее 150 слов. Обратите особое внимание на формулировку вопроса, необходимо переформулировать вопрос, чтобы ответ на него можно было найти в сообщениях. Нельзя изменять смысл вопроса, только переформулировать.")

        reasoning_summary: str = Field(description="Краткое изложение процесса пошагового рассуждения. Около 50 слов.")

        final_answer: str = Field(description="""
        - Основывавайтесь на пошаговом анализе и кратком изложении процесса
        - Возвращайте переформулированный вопрос
        - При выводе, должен быть только вопрос без каких-либо подводок                                                                                    
        """)